{# ══════════════════════════════════════════════════════════ #}
{# CADDY MAIN CONFIGURATION                                    #}
{# Generated from: blueprint-config.json                       #}
{# Location: ~/.config/caddy/Caddyfile                         #}
{# ══════════════════════════════════════════════════════════ #}

# ═════════════════════════════════════════════════════════════════════════════
# 🌐 GLOBAL OPTIONS
# ═════════════════════════════════════════════════════════════════════════════
{
  # Disable automatic HTTPS (Tailscale handles TLS)
  auto_https off
  
  # Disable admin API for security
  admin off
  
  # Log level
  log {
    level ERROR
  }
}

# ═════════════════════════════════════════════════════════════════════════════
# 📦 IMPORT SERVICE ROUTES
# Each service has its own .caddy file that defines its route
# Files are conditionally generated based on blueprint-config.json settings
# ═════════════════════════════════════════════════════════════════════════════

# Import all .caddy files from conf.d
import /etc/caddy/conf.d/*.caddy

# ═════════════════════════════════════════════════════════════════════════════
# 📝 ARCHITECTURE NOTES
# ═════════════════════════════════════════════════════════════════════════════
#
# SERVICE FILES IMPORTED:
{% for name, service in infrastructure.services %}
{%- if service.enabled and service.external_subdomain %}
#   - {{ name }}.caddy → https://{{ service.external_subdomain }}.{{ tailscale.full_hostname }}
{% endif -%}
{% endfor %}
#
# CONDITIONAL GENERATION:
#   Service .caddy files are only generated when:
#   - service.enabled = true
#   - service.external_subdomain is defined
#
# ADD NEW ROUTES:
#   1. Edit blueprint-config.json (infrastructure.services)
#   2. Set external_subdomain for the service
#   3. Create [service].caddy.njk template
#   4. Regenerate configs
#   5. Reload: systemctl --user reload caddy
#
# ═════════════════════════════════════════════════════════════════════════════
